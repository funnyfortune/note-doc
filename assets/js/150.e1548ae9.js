(window.webpackJsonp=window.webpackJsonp||[]).push([[150],{470:function(s,a,e){"use strict";e.r(a);var t=e(6),n=Object(t.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"常用解决方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#常用解决方案"}},[s._v("#")]),s._v(" 常用解决方案")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("MySQL-MMM 是 Master-Master Replication Manager for MySQL（mysql 主主复制管理 器）的简称，是 Google 的开源项目 （Perl 脚本）。MMM 基于 MySQL Replication 做的扩展架构，主要用 来监控 mysql 主主复制并做失败转 移。其原理是将真实数据库节点的 IP（RIP）映射为虚拟 IP（VIP）集。 mysql-mmm 的监管端会提供多个 虚拟 IP（VIP），包括一个可写 VIP， 多个可读 VIP，通过监管的管理，这 些 IP 会绑定在可用 mysql 之上，当 某一台 mysql 宕机时，监管会将 VIP 迁移至其他 mysql。在整个监管过 程中，需要在 mysql 中添加相关授 权用户，以便让 mysql 可以支持监 理机的维护。授权的用户包括一个\nmmm_monitor 用户和一个 mmm_agent 用户，如果想使用 mmm 的备份工具则还要添 加一个 mmm_tools 用户。\n"),a("img",{attrs:{src:"/img/dev/%E8%BF%90%E7%BB%B4%E9%83%A8%E7%BD%B2/mysql/mmm.png",alt:"mysql"}})])]),s._v(" "),a("li",[a("p",[s._v("MHA（Master High Availability）目前在 MySQL 高可用方面是一个相对成熟的解决方案, 由日本 DeNA 公司 youshimaton（现就职于 Facebook 公司）开发，是一套优秀的作为 MySQL高可用性环境下故障切换和主从提升的高可用软件。在MySQL故障切换过程中， MHA 能做到在 0~30 秒之内自动完成数据库的故障切换操作，并且在进行故障切换的过程中，MHA 能在最大程度上保证数据的一致性，以 达到真正意义上的高可用。")])]),s._v(" "),a("li",[a("p",[s._v("InnoDB Cluster 支持自动 Failover、强一致性、读写分离、读库高可用、读请求负载均 衡，横向扩展的特性，是比较完备的一套方案。但是部署起来复杂，想要解决 router 单点问题好需要新增组件，如没有其他更好的方案可考虑该方案。 InnoDB Cluster 主 要由 MySQL Shell、MySQL Router 和 MySQL 服务器集群组成，三者协同工作，共同为 MySQL 提供完整的高可用性解决方案。MySQL Shell 对管理人员提供管理接口，可以 很方便的对集群进行配置和管理,MySQL Router 可以根据部署的集群状况自动的初始 化，是客户端连接实例。如果有节点 down 机，集群会自动更新配置。集群包含单点写 入和多点写入两种模式。在单主模式下，如果主节点 down 掉，从节点自动替换上来， MySQL Router 会自动探测，并将客户端连接到新节点。\n"),a("img",{attrs:{src:"/img/dev/%E8%BF%90%E7%BB%B4%E9%83%A8%E7%BD%B2/mysql/db-cluster.png",alt:"mysql"}})])])]),s._v(" "),a("h2",{attrs:{id:"docker-安装-mysql-主从复制集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#docker-安装-mysql-主从复制集群"}},[s._v("#")]),s._v(" Docker 安装 MySQL 主从复制集群")]),s._v(" "),a("h3",{attrs:{id:"_1-创建-master-实例并启动"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-创建-master-实例并启动"}},[s._v("#")]),s._v(" 1. 创建 Master 实例并启动")]),s._v(" "),a("p",[s._v("1.1 启动")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run -p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3307")]),s._v(":3306 --name mysql-master "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v(" \n-v /mydata/mysql/master/log:/var/log/mysql "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v(" \n-v /mydata/mysql/master/data:/var/lib/mysql "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v(" \n-v /mydata/mysql/master/conf:/etc/mysql "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v(" \n-e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MYSQL_ROOT_PASSWORD")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("root "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v(" \n-d mysql:5.7 \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("参数说明")]),s._v(" "),a("ul",[a("li",[s._v("-p 3307:3306：将容器的 3306 端口映射到主机的 3307 端口")]),s._v(" "),a("li",[s._v("-v /mydata/mysql/master/conf:/etc/mysql：将配置文件夹挂在到主机")]),s._v(" "),a("li",[s._v("-v /mydata/mysql/master/log:/var/log/mysql：将日志文件夹挂载到主机")]),s._v(" "),a("li",[s._v("-v /mydata/mysql/master/data:/var/lib/mysql/：将配置文件夹挂载到主机")]),s._v(" "),a("li",[s._v("-e MYSQL_ROOT_PASSWORD=root：初始化 root 用户的密码")]),s._v(" "),a("li",[s._v("-d 后台运行")])])]),s._v(" "),a("p",[s._v("1.2 修改 master 基本配置")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /mydata/mysql/master/conf/my.cnf\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language-txt line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-txt"}},[a("code",[s._v("[client] \ndefault-character-set=utf8\n\n[mysql] \ndefault-character-set=utf8\n\n[mysqld]\ninit_connect='SET collation_connection = utf8_unicode_ci' \ninit_connect='SET NAMES utf8'\ncharacter-set-server=utf8 \ncollation-server=utf8_unicode_ci \nskip-character-set-client-handshake \nskip-name-resolve \n\n#注意：skip-name-resolve 一定要加，不然连接 mysql 会超级慢 \n\n#添加 master 主从复制部分配置 \nserver_id=1 \nlog-bin=mysql-bin \nread-only=0 \nbinlog-do-db=myapp_sys \nbinlog-do-db=myapp_user\n\n#忽略同步的数据库\nreplicate-ignore-db=mysql \nreplicate-ignore-db=sys \nreplicate-ignore-db=information_schema \nreplicate-ignore-db=performance_schema \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br")])]),a("p",[s._v("1.3 重启 master")]),s._v(" "),a("div",{staticClass:"language-shell script line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" restart mysql-master\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"_2-创建-slave-实例并启动"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-创建-slave-实例并启动"}},[s._v("#")]),s._v(" 2. 创建 Slave 实例并启动")]),s._v(" "),a("p",[s._v("2.1 启动")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run -p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3317")]),s._v(":3306 --name mysql-slaver-01 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v(" \n-v /mydata/mysql/slaver/log:/var/log/mysql "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v(" \n-v /mydata/mysql/slaver/data:/var/lib/mysql "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v(" \n-v /mydata/mysql/slaver/conf:/etc/mysql "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v(" \n-e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MYSQL_ROOT_PASSWORD")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("root "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v(" \n-d mysql:5.7 \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("2.2 修改 slave 基本配置")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /mydata/mysql/slaver/conf/my.cnf\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language-txt line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-txt"}},[a("code",[s._v("[client] \ndefault-character-set=utf8\n\n[mysql] \ndefault-character-set=utf8\n\n[mysqld]\ninit_connect='SET collation_connection = utf8_unicode_ci' \ninit_connect='SET NAMES utf8'\ncharacter-set-server=utf8 \ncollation-server=utf8_unicode_ci \nskip-character-set-client-handshake \nskip-name-resolve \n\n#注意：skip-name-resolve 一定要加，不然连接 mysql 会超级慢 \n\n#添加 slave 主从复制部分配置 \nserver_id=2 \nlog-bin=mysql-bin \nread-only=1\nbinlog-do-db=myapp_sys \nbinlog-do-db=myapp_user\n\n#忽略同步的数据库\nreplicate-ignore-db=mysql \nreplicate-ignore-db=sys \nreplicate-ignore-db=information_schema \nreplicate-ignore-db=performance_schema \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br")])]),a("p",[s._v("1.3 重启 master")]),s._v(" "),a("div",{staticClass:"language-shell script line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" restart mysql-slaver-01\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"_3-为-master-授权用户来他的同步数据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-为-master-授权用户来他的同步数据"}},[s._v("#")]),s._v(" 3. 为 master 授权用户来他的同步数据")]),s._v(" "),a("p",[s._v("3.1 进入 master 容器")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -it mysql-master /bin/bash\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("3.2 进入 mysql 内部（mysql –uroot -p）")]),s._v(" "),a("ul",[a("li",[a("ol",[a("li",[s._v("授权 root 可以远程访问（ 主从无关，为了方便我们远程连接 mysql）")])])])]),s._v(" "),a("div",{staticClass:"language-mysql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("grant all privileges on *.* to 'root'@'%' identified by 'root' with grant option; flush privileges;\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[a("ol",{attrs:{start:"2"}},[a("li",[s._v("添加用来同步的用户")])])])]),s._v(" "),a("div",{staticClass:"language-mysql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("GRANT REPLICATION SLAVE ON *.* to 'backup'@'%' identified by '123456'; \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("3.3 查看 master 状态")]),s._v(" "),a("div",{staticClass:"language-mysql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("show master status\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"_4-配置-slaver-同步-master-数据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-配置-slaver-同步-master-数据"}},[s._v("#")]),s._v(" 4. 配置 slaver 同步 master 数据")]),s._v(" "),a("p",[s._v("3.1 进入 slaver 容器")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -it mysql-slaver-01 /bin/bash\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("3.2 进入 mysql 内部（mysql –uroot -p）")]),s._v(" "),a("ul",[a("li",[a("ol",[a("li",[s._v("授权 root 可以远程访问（ 主从无关，为了方便我们远程连接 mysql）")])])])]),s._v(" "),a("div",{staticClass:"language-mysql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("grant all privileges on *.* to 'root'@'%' identified by 'root' with grant option; flush privileges;\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[a("ol",{attrs:{start:"2"}},[a("li",[s._v("设置主库连接")])])])]),s._v(" "),a("div",{staticClass:"language-mysql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("change master to master_host='192.168.65.100',master_user='backup',master_password='123456',master_log_file='mysql-bin.000003',master_log_pos=0,master_port=3306; \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("说明")]),s._v(" "),a("p",[s._v("参数通过 "),a("code",[s._v("show master status")]),s._v(" 显示结果获取。")])]),s._v(" "),a("ul",[a("li",[a("ol",{attrs:{start:"3"}},[a("li",[s._v("启动从库同步")])])])]),s._v(" "),a("div",{staticClass:"language-mysql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("start slave; \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[a("ol",{attrs:{start:"4"}},[a("li",[s._v("查看从库状态")])])])]),s._v(" "),a("div",{staticClass:"language-mysql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("show slave status\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),a("p",[s._v("结果显示 "),a("code",[s._v("Slave_IO_Running")]),s._v(" 和 "),a("code",[s._v("Slave_SQL_Running")]),s._v(" 为 "),a("code",[s._v("Yes")]),s._v(" 则主从配置完成。")])])])}),[],!1,null,null,null);a.default=n.exports}}]);